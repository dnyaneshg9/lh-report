import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Download, FileText } from 'lucide-react';

const LHFertilityReport = () => {
  const [formData, setFormData] = useState({
    name: '',
    address: '',
    pinCode: '',
    age: '',
    sex: 'Female',
    lhPercentage: ''
  });

  const [reportData, setReportData] = useState(null);

  const handleInputChange = (e) => {
    const { id, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [id]: value
    }));
  };

  const generateReport = () => {
    const { name, address, pinCode, age, sex, lhPercentage } = formData;

    if (!name || !address || !pinCode || !age || !lhPercentage) {
      alert("Please fill all fields with valid information.");
      return;
    }

    const now = new Date();
    const registeredDate = now.toLocaleString();
    const collectedDate = now.toLocaleString();
    const reportedDate = now.toLocaleString();

    // Calculate LH value (assuming 45 mIU/ml = 100%)
    const lhValue = ((parseFloat(lhPercentage) / 100) * 45).toFixed(2);

    let fertilityLevel = "Low";
    let ovulationPrediction = "Not Ovulating";

    if (parseFloat(lhPercentage) >= 55) {
      fertilityLevel = "High";
      ovulationPrediction = "12-24 Hrs";
    } else if (parseFloat(lhPercentage) >= 22) {
      fertilityLevel = "Moderate";
      ovulationPrediction = "Approaching Ovulation";
    }

    setReportData({
      name, address, pinCode, age, sex,
      registeredDate,
      collectedDate,
      reportedDate,
      lhValue,
      lhPercentage,
      fertilityLevel,
      ovulationPrediction
    });
  };

  const downloadReport = () => {
    if (!reportData) return;

    const reportContent = `
URINE LH SAMPLE QUANTIFICATION REPORT

Patient Name : ${reportData.name}
Address : ${reportData.address}
PIN code : ${reportData.pinCode}
Age : ${reportData.age}
Sex : ${reportData.sex}

Date & time
Registered on: ${reportData.registeredDate}
Collected on: ${reportData.collectedDate}
Reported on: ${reportData.reportedDate}

Investigation | Observed Value | Unit | Biological Reference Interval
LH (Leutinizing Harmone) | ${reportData.lhValue} | mIU/ml | Normal Menstruating Women
                          |           |        | Follicular Phase <10
                          |           |        | Pre-Ovulatory Phase 10-25
                          |           |        | LH Surge (Ovulation) 25-40+
                          |           |        | Luteal Phase <10

LH % Found : ${reportData.lhPercentage}%
Fertility Level detected : ${reportData.fertilityLevel}
Ovulation Prediction : ${reportData.ovulationPrediction}

Interpretation:
Luteinizing Hormone (LH) is secreted by the anterior pituitary gland and plays a crucial role in ovulation. The urine-based LH test helps detect the LH surge, which triggers ovulation.

Clinical Utility:
- Ovulation prediction for natural conception or assisted reproduction (IUI, IVF).
- Menstrual cycle monitoring in irregular periods, PCOS, and ovarian insufficiency.
- Fertility treatment support to time ovulation induction therapies.
- At-home, cost-effective alternative to serum LH testing.
- Levels detection.
- PCOS (Polycystic Ovary Syndrome) Consistently high LH (>25 mIU/mL) Hormonal imbalance, irregular ovulation
- Menopause 15-30 mIU/mL (but no surge) Ovarian failure, no ovulation
- Anovulation (No Ovulation) LH remains low (<10 mIU/mL) Hormonal disorder, stress, excessive exercise
- To avoid pregnancy chances by hormonal levels.

Caution:
- Cycle variability: Women with irregular cycles may need to test for several days to detect the LH surge.
- Not a diagnostic tool: This test is for ovulation tracking only; serum LH testing is recommended for hormonal disorders.
`;

    const blob = new Blob([reportContent], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Urine_LH_Report.txt';
    link.click();
  };

  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle className="text-center">Urine LH Sample Quantification Report</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            <Input 
              id="name" 
              placeholder="Patient Name" 
              value={formData.name}
              onChange={handleInputChange}
              required 
            />
            <Input 
              id="address" 
              placeholder="Address" 
              value={formData.address}
              onChange={handleInputChange}
              required 
            />
            <Input 
              id="pinCode" 
              placeholder="PIN Code" 
              value={formData.pinCode}
              onChange={handleInputChange}
              required 
            />
            <Input 
              id="age" 
              type="number" 
              placeholder="Age" 
              value={formData.age}
              onChange={handleInputChange}
              required 
            />
            <Select 
              value={formData.sex}
              onValueChange={(value) => setFormData(prev => ({...prev, sex: value}))}
            >
              <SelectTrigger>
                <SelectValue placeholder="Sex" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="Female">Female</SelectItem>
              </SelectContent>
            </Select>
            <Input 
              id="lhPercentage" 
              type="number" 
              placeholder="LH Percentage (%)" 
              value={formData.lhPercentage}
              onChange={handleInputChange}
              required 
            />
          </div>

          <Button onClick={generateReport} className="w-full">
            <FileText className="mr-2" /> Generate Report
          </Button>

          {reportData && (
            <div className="mt-4 p-4 bg-white border rounded-lg">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p><strong>Patient Name:</strong> {reportData.name}</p>
                  <p><strong>Address:</strong> {reportData.address}</p>
                  <p><strong>PIN Code:</strong> {reportData.pinCode}</p>
                  <p><strong>Age:</strong> {reportData.age}</p>
                  <p><strong>Sex:</strong> {reportData.sex}</p>
                </div>
                <div className="text-right">
                  <div className="bg-gray-100 p-2 rounded">
                    <p><strong>Date & Time</strong></p>
                    <p>Registered on: {reportData.registeredDate}</p>
                    <p>Collected on: {reportData.collectedDate}</p>
                    <p>Reported on: {reportData.reportedDate}</p>
                  </div>
                </div>
              </div>

              <table className="w-full border-collapse border mt-4">
                <thead>
                  <tr>
                    <th className="border p-2">Investigation</th>
                    <th className="border p-2">Observed Value</th>
                    <th className="border p-2">Unit</th>
                    <th className="border p-2">Biological Reference Interval</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td className="border p-2">LH (Leutinizing Harmone)</td>
                    <td className="border p-2">{reportData.lhValue}</td>
                    <td className="border p-2">mIU/ml</td>
                    <td className="border p-2">
                      Normal Menstruating Women<br />
                      Follicular Phase &lt;10<br />
                      Pre-Ovulatory Phase 10-25<br />
                      LH Surge (Ovulation) 25-40+<br />
                      Luteal Phase &lt;10
                    </td>
                  </tr>
                </tbody>
              </table>

              <div className="mt-4">
                <p><strong>LH % Found:</strong> {reportData.lhPercentage}%</p>
                <p><strong>Fertility Level detected:</strong> {reportData.fertilityLevel}</p>
                <p><strong>Ovulation Prediction:</strong> {reportData.ovulationPrediction}</p>
              </div>

              <Button onClick={downloadReport} className="mt-4 w-full">
                <Download className="mr-2" /> Download Report
              </Button>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
};

export default LHFertilityReport;
